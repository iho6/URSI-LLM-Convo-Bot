{"code":"import \"@mediapipe/face_mesh\";\nimport autoBind from \"auto-bind\";\nimport { Euler, Matrix4, Vector3 } from \"three\";\nclass MediapipeFacemeshExtension {\n    constructor(jsPsych) {\n        this.jsPsych = jsPsych;\n        this.recordedChunks = new Array();\n        this.onResultCallbacks = new Array();\n        this.recordTracks = false;\n        this.initialize = (params) => {\n            var _a;\n            this.faceMesh = new FaceMesh({\n                locateFile: (_a = params === null || params === void 0 ? void 0 : params.locateFile) !== null && _a !== void 0 ? _a : function (file) {\n                    return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;\n                },\n            });\n            // Set the options for the face mesh tracking\n            this.faceMesh.setOptions({\n                maxNumFaces: 1,\n                // can not be used together with refineLandmarks\n                enableFaceGeometry: true,\n                minDetectionConfidence: 0.5,\n                minTrackingConfidence: 0.5,\n                // can not be used together with enableFaceGeometry\n                refineLandmarks: false,\n            });\n            return new Promise((resolve, reject) => {\n                this.faceMesh.initialize().then(resolve, reject);\n            });\n        };\n        this.on_start = () => {\n            var _a, _b;\n            (_a = this.canvasElement) === null || _a === void 0 ? void 0 : _a.remove();\n            (_b = this.videoElement) === null || _b === void 0 ? void 0 : _b.remove();\n            // Create Canvas\n            this.canvasElement = document.createElement(\"canvas\");\n            this.canvasElement.width = 1280;\n            this.canvasElement.height = 720;\n            this.videoElement = document.createElement(\"video\");\n            this.videoElement.muted = true;\n            this.mediaStream = this.jsPsych.pluginAPI.getCameraStream();\n            if (!this.mediaStream) {\n                console.warn(\"The mediapipe-face-mesh extension is trying to start but the camera is not initialized. Do you need to run the initialize-camera plugin?\");\n                return;\n            }\n            this.videoElement.srcObject = this.mediaStream;\n            this.videoElement.onloadedmetadata = () => {\n                // Stop animation frame to prevent performance leaks.\n                this.stopAnimationFrame();\n                this.animationFrameId = window.requestAnimationFrame(this.processFrame.bind(this));\n            };\n            this.faceMesh.onResults(this.onMediaPipeResult.bind(this));\n            this.videoElement.play();\n        };\n        this.on_load = (params) => {\n            var _a;\n            this.recordedChunks = new Array();\n            this.recordTracks = (_a = params === null || params === void 0 ? void 0 : params.record) !== null && _a !== void 0 ? _a : false;\n        };\n        this.on_finish = () => {\n            console.log(\"face_mesh tracked chunks: \" + this.recordedChunks.length);\n            this.stopAnimationFrame();\n            this.recordTracks = false;\n            return { face_mesh: this.recordedChunks };\n        };\n        autoBind(this);\n    }\n    /**\n     * Stop the current animation frame to prevent performance leakage.\n     */\n    stopAnimationFrame() {\n        window.cancelAnimationFrame(this.animationFrameId);\n    }\n    processFrame() {\n        const canvasContext = this.canvasElement.getContext(\"2d\");\n        canvasContext.drawImage(this.videoElement, 0, 0);\n        this.faceMesh.send({ image: this.canvasElement });\n        this.animationFrameId = window.requestAnimationFrame(this.processFrame.bind(this));\n    }\n    addTrackingResultCallback(callback) {\n        this.onResultCallbacks.push(callback);\n    }\n    removeTrackingResultCallback(callback) {\n        this.onResultCallbacks.splice(this.onResultCallbacks.indexOf(callback), 1);\n    }\n    onMediaPipeResult(results) {\n        if (results.multiFaceGeometry[0] !== undefined) {\n            const transformationMatrix = results.multiFaceGeometry[0]\n                .getPoseTransformMatrix()\n                .getPackedDataList();\n            const rotation = new Euler().setFromRotationMatrix(new Matrix4().fromArray(transformationMatrix));\n            const translation = new Vector3().setFromMatrixPosition(new Matrix4().fromArray(transformationMatrix));\n            const result = {\n                frame_id: this.animationFrameId,\n                transformation: transformationMatrix,\n                rotation: rotation,\n                translation: translation,\n            };\n            if (this.recordTracks)\n                this.recordedChunks.push(result);\n            this.onResultCallbacks.forEach((callback) => {\n                callback(result);\n            });\n        }\n    }\n}\nMediapipeFacemeshExtension.info = {\n    name: \"mediapipe-face-mesh\",\n};\nexport default MediapipeFacemeshExtension;\n//# sourceMappingURL=index.js.map","references":["/Users/jackie3/Desktop/URSI/jspsych-contrib/node_modules/@mediapipe/face_mesh/index.d.ts","/Users/jackie3/Desktop/URSI/jspsych-contrib/node_modules/auto-bind/index.d.ts","/Users/jackie3/Desktop/URSI/jspsych-contrib/node_modules/jspsych/dist/index.d.ts","/Users/jackie3/Desktop/URSI/jspsych-contrib/node_modules/@types/three/index.d.ts"],"map":"{\"version\":3,\"file\":\"index.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../src/index.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/Users/jackie3/Desktop/URSI/jspsych-contrib/packages/extension-mediapipe-face-mesh/node_modules/.cache/rollup-plugin-typescript2/placeholder/index.d.ts","writeByteOrderMark":false,"text":"import \"@mediapipe/face_mesh\";\nimport { JsPsych, JsPsychExtension, JsPsychExtensionInfo } from \"jspsych\";\nimport { Euler, Vector3 } from \"three\";\ninterface IFaceTrackingResult {\n    frame_id: number;\n    transformation: number[];\n    rotation: Euler;\n    translation: Vector3;\n}\ndeclare class MediapipeFacemeshExtension implements JsPsychExtension {\n    private jsPsych;\n    static info: JsPsychExtensionInfo;\n    private recordedChunks;\n    private animationFrameId;\n    mediaStream: MediaStream;\n    private videoElement;\n    private canvasElement;\n    private faceMesh;\n    private onResultCallbacks;\n    private recordTracks;\n    constructor(jsPsych: JsPsych);\n    initialize: (params: any) => Promise<void>;\n    on_start: () => void;\n    on_load: (params: any) => void;\n    on_finish: () => {\n        face_mesh: IFaceTrackingResult[];\n    };\n    /**\n     * Stop the current animation frame to prevent performance leakage.\n     */\n    private stopAnimationFrame;\n    private processFrame;\n    addTrackingResultCallback(callback: (ITrackingResult: any) => void): void;\n    removeTrackingResultCallback(callback: (ITrackingResult: any) => void): void;\n    private onMediaPipeResult;\n}\nexport default MediapipeFacemeshExtension;\n"}}
