{"version":3,"file":"index.browser.min.js","names":["jsPsychNextcloudFiledropPlugin","jspsych","info","name","parameters","url","type","ParameterType","STRING","default","folder","filename","FUNCTION","generate_download_url_on_error","BOOL","NextcloudFiledropPlugin","a","jsPsych","_classCallCheck","_createClass","key","value","trial","display_element","c","data","get","json","Date","toJSON","trial_data","error","progress_bar_container","document","createElement","id","style","height","width","backgroundColor","margin","progress_bar_text","progress_bar","appendChild","getDisplayElement","zip","JSZip","file","generateAsync","metadata","innerHTML","perc","percent","toFixed","then","blob","xhr","XMLHttpRequest","upload","addEventListener","event","b","Math","round","console","log","loaded","total","removeChild","finishTrial","evt","URL","createObjectURL","open","setRequestHeader","btoa","send","jsPsychModule"],"sources":["../index.js"],"sourcesContent":["var jsPsychNextcloudFiledropPlugin = (function (jspsych) {\n  \"use strict\";\n\n  const info = {\n    name: \"nextcloud-upload\",\n    parameters: {\n      url: {\n        type: jspsych.ParameterType.STRING,\n        default: undefined,\n      },\n      folder: {\n        type: jspsych.ParameterType.STRING,\n        default: undefined,\n      },\n      filename: {\n        type: jspsych.ParameterType.FUNCTION,\n        default: null,\n      },\n      generate_download_url_on_error: {\n        type: jspsych.ParameterType.BOOL,\n        default: false,\n      },\n    },\n  };\n\n  /**\n   * **NEXTCLOUD-UPLOAD**\n   *\n   * This plugin can be used to save jsPsych data\n   * to a nextcloud instance using the file drop method.\n   * Please refer to README.md for details.\n   *\n   * @author Martin Grewe\n   */\n  class NextcloudFiledropPlugin {\n    constructor(jsPsych) {\n      this.jsPsych = jsPsych;\n    }\n    trial(display_element, trial) {\n      let data = this.jsPsych.data.get().json();\n\n      // Determine filename\n      let filename =\n        trial[\"filename\"] == null ? new Date().toJSON() + \".zip\" : trial[\"filename\"](this.jsPsych);\n\n      var trial_data = {\n        filename: filename,\n        error: false,\n      };\n\n      var progress_bar_container = document.createElement(\"div\");\n      progress_bar_container.id = \"jspsych-loading-progress-bar-container\";\n      progress_bar_container.style.height = \"10px\";\n      progress_bar_container.style.width = \"300px\";\n      progress_bar_container.style.backgroundColor = \"#ddd\";\n      progress_bar_container.style.margin = \"auto\";\n\n      var progress_bar_text = document.createElement(\"p\");\n\n      var progress_bar = document.createElement(\"div\");\n      progress_bar.id = \"jspsych-loading-progress-bar\";\n      progress_bar.style.height = \"10px\";\n      progress_bar.style.width = \"0px\";\n      progress_bar.style.backgroundColor = \"#777\";\n\n      progress_bar_container.appendChild(progress_bar);\n      this.jsPsych.getDisplayElement().appendChild(progress_bar_text);\n      this.jsPsych.getDisplayElement().appendChild(progress_bar_container);\n\n      var zip = new JSZip();\n      zip.file(\"data.json\", data);\n\n      zip\n        .generateAsync({ type: \"blob\" }, (metadata) => {\n          progress_bar_text.innerHTML = \"Compressing data, please be patient.\";\n          const perc = metadata.percent.toFixed(2);\n          // console.log(\"Compression progress: \" + perc);\n          progress_bar.style.width = perc + \"%\";\n        })\n        .then((blob) => {\n          const xhr = new XMLHttpRequest();\n\n          // Progress callback\n          xhr.upload.addEventListener(\"progress\", (event) => {\n            progress_bar_text.innerHTML = \"Uploading data, please be patient.\";\n            console.log(\"Upload progress: \" + Math.round((event.loaded / event.total) * 100));\n            progress_bar.style.width = Math.round((event.loaded / event.total) * 100) + \"%\";\n          });\n\n          // Upload finished callback\n          xhr.addEventListener(\"loadend\", () => {\n            console.log(\"Upload finished.\");\n            this.jsPsych.getDisplayElement().removeChild(progress_bar_text);\n            this.jsPsych.getDisplayElement().removeChild(progress_bar_container);\n            display_element.innerHTML = \"Upload finished.\";\n            this.jsPsych.finishTrial(trial_data);\n          });\n\n          // Upload error callback\n          xhr.addEventListener(\"error\", (evt) => {\n            console.log(\"Upload error.\", evt);\n            trial_data.error = true;\n            if (trial[\"generate_download_url_on_error\"]) {\n              trial_data.url = URL.createObjectURL(blob);\n              trial_data.filename = filename;\n            }\n          });\n\n          const url = trial[\"url\"] + \"/public.php/webdav/\" + filename;\n          xhr.open(\"PUT\", url, true);\n          xhr.setRequestHeader(\"Authorization\", \"Basic \" + btoa(trial[\"folder\"] + \":\"));\n          xhr.send(blob);\n        });\n\n      // end trial\n    }\n  }\n  NextcloudFiledropPlugin.info = info;\n\n  return NextcloudFiledropPlugin;\n})(jsPsychModule);\n"],"mappings":"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"}